# CRV BSM to Openpilot



## 1. 盲区监测信号 B-CAN DBC

```
BO_ 318291879 BSM_STATUS_RIGHT: 8 XXX
 SG_ BSM_ALERT : 4|1@0+ (1,0) [0|1] "" XXX
 SG_ BSM_MODE : 6|2@0+ (1,0) [0|3] "" XXX

BO_ 318291615 BSM_STATUS_LEFT: 8 XXX
 SG_ BSM_ALERT : 4|1@0+ (1,0) [0|1] "" XXX
 SG_ BSM_MODE : 6|2@0+ (1,0) [0|3] "" XXX

VAL_ 318291879 BSM_MODE 2 "blind_spot" 1 "cross_traffic" 0 "off";
VAL_ 318291615 BSM_MODE 2 "blind_spot" 1 "cross_traffic" 0 "off";`
```



```
opendbc/honda_crv_ex_2017_body_generated.dbc

CM_ "AUTOGENERATED FILE, DO NOT EDIT";

CM_ "honda_crv_ex_2017_body.dbc starts here";
BO_ 318291879 BSM_STATUS_RIGHT: 8 XXX
 SG_ BSM_ALERT : 4|1@0+ (1,0) [0|1] "" XXX
 SG_ BSM_MODE : 6|2@0+ (1,0) [0|3] "" XXX

BO_ 318291615 BSM_STATUS_LEFT: 8 XXX
 SG_ BSM_ALERT : 4|1@0+ (1,0) [0|1] "" XXX
 SG_ BSM_MODE : 6|2@0+ (1,0) [0|3] "" XXX

VAL_ 318291879 BSM_MODE 2 "blind_spot" 1 "cross_traffic" 0 "off";
VAL_ 318291615 BSM_MODE 2 "blind_spot" 1 "cross_traffic" 0 "off";


318291879 0x12F8BFA7   //BSM RIGHT
318291615 0x12F8BE9F   //BSM LEFT

"384899312" 0x16F118F0  //BCM request

BUS0 RX and forward to BUS1(B-CAN)
```

https://github.com/commaai/openpilot/pull/1867



## 2. connect B-CAN to CAN0?

https://github.com/gregjhogan/panda/tree/bcan-fwd

https://github.com/gregjhogan/panda/commit/97b5c218010aa3e1a4334b4cc6963da5584f1058

```
static void honda_gateway_init(int16_t param) {
  UNUSED(param);
  relay_malfunction_reset0x12F8BFA7
  // TODO: set CAN speed here?
  // can_speed[1] = 1250;
  // can_init(CAN_NUM_FROM_BUS_NUM(1));
}

static int honda_gateway_fwd_hook(int bus_num, CAN_FIFOMailBox_TypeDef *to_fwd) {
  int bus_fwd = -1;
  int addr = GET_ADDR(to_fwd);

  // 0x16F118F0 = BCM request
  bool bcan_out = (addr == 0x16F118F0);
  if ((bus_num == 0) && bcan_out) {
    bus_fwd = 1;
  }

  // 0x16F1F018 = BCM response
  // 0x12F8BFA7 = BSM status right
  // 0x12F8BE9F = BSM status left
  bool bcan_in = (addr == 0x16F1F018) || (addr == 0x12F8BFA7) || (addr == 0x12F8BE9F);
  if ((bus_num == 1) && bcan_in) {
    bus_fwd = 0;
  }

  return bus_fwd;
}

const safety_hooks honda_gateway_hooks = {
  .init = honda_gateway_init,
  .rx = default_rx_hook,
  .tx = alloutput_tx_hook,
  .tx_lin = alloutput_tx_lin_hook,
  .fwd = honda_gateway_fwd_hook,
};
```

- B-CAN 的波特率是125Kbps    接BUS1
- CAR-CAN的波特率是500Kbps 接BUS0
- Forward  0x16F1F018,0x12F8BFA7,0x12F8BE9F from BUS1 to BUS0
- Forward  0x16F1F018 from BUS0 to BUS1

## 3.参考
1. https://www.waveshare.net/w/upload/4/4c/STM32F4xxx_reference_manual_CN.pdf
2. 